<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sosyal Medya PaylaÅŸÄ±m Takip Sistemi â€“ GENEL Ä°CMAL</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    th, td { white-space: nowrap; }
    input[type="checkbox"] { transform: scale(1.1); accent-color: #2563EB; }
    .social-media-yes { background-color: #A7F3D0 !important; color: #065F46 !important; }
    .social-media-maybe { background-color: #FDE68A !important; color: #92400E !important; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">
  <div class="container mx-auto p-6 md:p-10 lg:p-12">
    <div class="bg-white rounded-3xl shadow-xl p-6 md:p-10">
      <h1 class="text-3xl md:text-4xl lg:text-5xl font-extrabold text-center text-gray-700 mb-8">
        Sosyal Medya PaylaÅŸÄ±m Takip Sistemi â€“ GENEL Ä°CMAL
      </h1>

      <div class="flex flex-wrap justify-center gap-3 md:gap-4 mb-8">
        <button onclick="document.getElementById('xlsxInput').click()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow">.xlsx YÃ¼kle</button>
        <button onclick="exportToXLSX()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow">.xlsx Ä°ndir</button>
        <button onclick="showNewRecordForm()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-full shadow">Yeni KayÄ±t</button>
        <button onclick="clearData()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full shadow">Temizle (Bulut+Ã–nbellek)</button>
      </div>
      <input type="file" id="xlsxInput" accept=".xlsx" class="hidden" onchange="handleFile(this.files)">

      <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6 mb-8">
        <div class="bg-indigo-100 text-indigo-800 rounded-xl p-5 shadow cursor-pointer" onclick="filterByShareStatus('all')">
          <div class="font-semibold">Toplam KayÄ±t</div><div id="totalCount" class="text-3xl md:text-4xl font-extrabold">0</div>
        </div>
        <div class="bg-emerald-100 text-emerald-800 rounded-xl p-5 shadow cursor-pointer" onclick="filterByShareStatus('shared')">
          <div class="font-semibold">PaylaÅŸÄ±lan</div><div id="sharedCount" class="text-3xl md:text-4xl font-extrabold">0</div>
        </div>
        <div class="bg-rose-100 text-rose-800 rounded-xl p-5 shadow cursor-pointer" onclick="filterByShareStatus('unshared')">
          <div class="font-semibold">PaylaÅŸÄ±lmayan</div><div id="unsharedCount" class="text-3xl md:text-4xl font-extrabold">0</div>
        </div>
        <div class="bg-sky-100 text-sky-800 rounded-xl p-5 shadow cursor-pointer" onclick="filterByUpcoming()">
          <div class="font-semibold">YaklaÅŸan PaylaÅŸÄ±mlar</div><div id="upcomingCount" class="text-3xl md:text-4xl font-extrabold">0</div>
        </div>
        <div class="bg-amber-100 text-amber-800 rounded-xl p-5 shadow cursor-pointer" onclick="filterByCurrent()">
          <div class="font-semibold">Filtrelenen SatÄ±r</div><div id="filteredCount" class="text-3xl md:text-4xl font-extrabold">0</div>
        </div>
      </div>

      <div class="bg-blue-50 p-5 rounded-xl mb-6">
        <div class="flex flex-wrap items-end gap-4 justify-center">
          <div>
            <label class="block text-sm font-semibold text-blue-900">PaylaÅŸÄ±m Rutini</label>
            <select id="routineFilter" onchange="applyFilters()" class="mt-1 rounded-md border-gray-300 p-2">
              <option value="">TÃ¼mÃ¼</option><option>Spontane</option><option>AylÄ±k</option><option>YÄ±llÄ±k</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-blue-900">Sosyal Medyada PaylaÅŸÄ±lacak mÄ±?</label>
            <select id="socialMediaFilter" onchange="applyFilters()" class="mt-1 rounded-md border-gray-300 p-2">
              <option value="">TÃ¼mÃ¼</option><option>Evet</option><option>HayÄ±r</option><option>Belki</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-blue-900">Kurum</label>
            <input id="institutionFilter" oninput="applyFilters()" class="mt-1 rounded-md border-gray-300 p-2" placeholder="Kurum adÄ± yazÄ±n">
          </div>
          <div>
            <label class="block text-sm font-semibold text-blue-900">SektÃ¶r</label>
            <select id="sectorFilter" onchange="applyFilters()" class="mt-1 rounded-md border-gray-300 p-2">
              <option value="">TÃ¼mÃ¼</option>
            </select>
          </div>
          <button onclick="clearFilters()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md">Filtreleri Temizle</button>
        </div>
      </div>

      <div class="bg-gray-50 p-6 rounded-xl shadow mb-8">
        <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">GÃ¶rÃ¼nÃ¼r SÃ¼tunlar</h3>
        <div id="columnCheckboxes" class="flex flex-wrap justify-center gap-x-6 gap-y-2 text-sm text-gray-700"></div>
      </div>

      <div id="dropZone" class="border-2 border-dashed border-gray-400 rounded-xl p-6 text-center text-gray-500 mb-8">
        DosyanÄ±zÄ± buraya sÃ¼rÃ¼kleyip bÄ±rakÄ±n (.xlsx)
      </div>

      <div class="overflow-x-auto rounded-xl shadow-md">
        <table class="w-full text-sm text-left text-gray-600">
          <thead class="text-xs text-gray-700 uppercase bg-gray-200 sticky top-0 border-b">
            <tr id="tableHeadRow">
              <th class="py-3 px-6"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
              <!-- Dinamik baÅŸlÄ±klar -->
              <th class="py-3 px-6">Ä°ÅŸlemler</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="bg-white divide-y"></tbody>
        </table>
      </div>

      <div id="newRecordModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-8 rounded-xl bg-white shadow-2xl w-11/12 md:max-w-xl lg:max-w-2xl">
          <span class="text-gray-500 hover:text-gray-700 text-3xl font-bold absolute top-4 right-6 cursor-pointer" onclick="closeNewRecordModal()">&times;</span>
          <h2 class="text-2xl font-bold text-gray-700 mb-6 text-center">Yeni KayÄ±t Ekle/DÃ¼zenle</h2>
          <form id="recordForm">
            <input type="hidden" name="id" />
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="formFields"></div>
            <div class="flex justify-end mt-6 gap-3">
              <button type="button" onclick="closeNewRecordModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md">Ä°ptal</button>
              <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md">Kaydet</button>
            </div>
          </form>
        </div>
      </div>

      <p class="text-center text-sm text-gray-500 mt-8">Veriler Google Sheets'te (GENEL Ä°CMAL) saklanÄ±r, son gÃ¶rÃ¼nÃ¼m Ã¶nbelleÄŸe alÄ±nÄ±r.</p>
    </div>
  </div>

<script>
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbwRDOtvOzakzoqu-3-Cga-_AUDqarGjbQ_tdimozxqfZLv0m9dZPk2P0DGJ_uOQpt28KA/exec";
const DEFAULT_VISIBLE = {
  'Kurum': true,
  'Alt Kurum': false,
  'SektÃ¶r': false,
  'PaylaÅŸÄ±m Konusu': true,
  'PaylaÅŸÄ±m Tarihi': true,
  'Belirli bir gÃ¼nÃ¼ ve haftasÄ± var mÄ±?': false,
  'Ä°rtibat KiÅŸisinin ÃœnvanÄ±': false,
  'Ä°rtibat KiÅŸisinin AdÄ± SoyadÄ±': false,
  'PaylaÅŸtÄ±ÄŸÄ±mÄ±z GÃ¶nderinin BaÄŸlantÄ± Adresi': false,
  'AÃ§Ä±klama': true,
  'Almanakta yer alan belirli gÃ¼n ve hafta ismi': false,
  'BakanlÄ±ÄŸÄ±n PaylaÅŸÄ±m Metni': false,
  "TUÄ°K'te var mÄ±?": false,
  "TUÄ°K'te yayÄ±mlanma takvimi": false,
  'PaylaÅŸÄ±m Rutini': false,
  'Sosyal Medyada PaylaÅŸÄ±lacak mÄ±?': false,
  'Kaynak': false,
  'Kaynak Ä°nternet Adresi': false,
  'BakanlÄ±k Sosyal Medya PaylaÅŸÄ±mÄ± Var mÄ±?': false,
  'PaylaÅŸÄ±ldÄ±': false
};
const SHEET_COLUMNS = Object.keys(DEFAULT_VISIBLE).concat(['id']); // id saklÄ±

let visibleCols = loadVisibleCols();
let data = [];
let filteredData = [];
let currentShareFilter = 'all';

function loadVisibleCols(){
  try{ const s = localStorage.getItem('smts_visible_cols'); if(s){ return { ...DEFAULT_VISIBLE, ...JSON.parse(s) }; } }catch(e){}
  return { ...DEFAULT_VISIBLE };
}
function saveVisibleCols(){ localStorage.setItem('smts_visible_cols', JSON.stringify(visibleCols)); }
function uid(){ return 'id-' + Math.random().toString(36).slice(2) + Date.now(); }
function formatColumnName(col){
  const map = {
    'PaylaÅŸÄ±m Konusu':'Konu',
    'PaylaÅŸtÄ±ÄŸÄ±mÄ±z GÃ¶nderinin BaÄŸlantÄ± Adresi':'PaylaÅŸÄ±m Adresi',
    'Almanakta yer alan belirli gÃ¼n ve hafta ismi':'Almanak AdÄ±',
    'BakanlÄ±ÄŸÄ±n PaylaÅŸÄ±m Metni':'BakanlÄ±k Metni',
    "TUÄ°K'te yayÄ±mlanma takvimi":'TUÄ°K Takvimi',
    'Kaynak Ä°nternet Adresi':'Kaynak Web Adresi',
    'BakanlÄ±k Sosyal Medya PaylaÅŸÄ±mÄ± Var mÄ±?':'BakanlÄ±k PaylaÅŸÄ±mÄ± Var mÄ±?',
    'PaylaÅŸÄ±ldÄ±':'PaylaÅŸÄ±ldÄ± âœ”'
  }; return map[col] || col;
}

// Backend
async function backend(action, payload={}){
  const res = await fetch(BACKEND_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify({ action, ...payload })
  });
  if(!res.ok) throw new Error('AÄŸ hatasÄ±');
  return await res.json();
}

async function loadFromCloud(){
  const cached = localStorage.getItem('smts_cache');
  if (cached) { try { data = JSON.parse(cached); filteredData = [...data]; updateAfterDataChange(); } catch(e){} }
  const result = await backend('list');
  data = result.rows || [];
  filteredData = [...data];
  localStorage.setItem('smts_cache', JSON.stringify(data));
  updateAfterDataChange();
}
async function createOnCloud(record){ record.id = record.id || uid(); await backend('create', { record }); }
async function updateOnCloud(record){ if(!record.id) throw new Error('id yok'); await backend('update', { record }); }
async function deleteOnCloud(id){ await backend('delete', { id }); }
async function clearCloud(){ await backend('clear'); }

// Excel iÃ§e/dÄ±ÅŸa
function handleFile(files){
  const file = files[0];
  if (file && file.name.endsWith('.xlsx')) {
    const reader = new FileReader();
    reader.onload = async (e) => {
      const wb = XLSX.read(e.target.result, { type: 'binary' });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet);
      const rows = json.map(row => {
        const r = {}; Object.keys(DEFAULT_VISIBLE).forEach(k => r[k] = row[k] ?? '');
        if (!r['Sosyal Medyada PaylaÅŸÄ±lacak mÄ±?']) r['Sosyal Medyada PaylaÅŸÄ±lacak mÄ±?'] = 'HayÄ±r';
        if (r['PaylaÅŸÄ±m Tarihi'] && typeof r['PaylaÅŸÄ±m Tarihi'] === 'number'){
          r['PaylaÅŸÄ±m Tarihi'] = new Date(Date.UTC(0,0,r['PaylaÅŸÄ±m Tarihi']-1)).toISOString().slice(0,10);
        }
        return r;
      });
      await clearCloud();
      for (const rec of rows){ await createOnCloud(rec); }
      await loadFromCloud();
    };
    reader.readAsBinaryString(file);
  }
}
function exportToXLSX(){
  const ws = XLSX.utils.json_to_sheet(filteredData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'PaylaÅŸÄ±m Paneli');
  XLSX.writeFile(wb, 'paylasim_paneli.xlsx');
}

// Filtreler
function isUpcoming(row){
  if (!row['PaylaÅŸÄ±m Tarihi']) return false;
  const planned = new Date(row['PaylaÅŸÄ±m Tarihi']);
  const today = new Date(); today.setHours(0,0,0,0);
  const tenDays = new Date(today); tenDays.setDate(today.getDate()+10); tenDays.setHours(23,59,59,999);
  return planned >= today && planned <= tenDays && !row['PaylaÅŸÄ±ldÄ±'];
}
function updateSectorFilter(){
  const sectors = [...new Set(data.map(r => r['SektÃ¶r']).filter(Boolean))];
  const sel = document.getElementById('sectorFilter');
  sel.innerHTML = '<option value="">TÃ¼mÃ¼</option>';
  sectors.forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });
}
function applyFilters(){
  let temp = [...data];
  if (currentShareFilter === 'shared') temp = temp.filter(r => r['PaylaÅŸÄ±ldÄ±']);
  else if (currentShareFilter === 'unshared') temp = temp.filter(r => !r['PaylaÅŸÄ±ldÄ±']);
  else if (currentShareFilter === 'upcoming') temp = temp.filter(isUpcoming);

  const institution = document.getElementById('institutionFilter').value.trim().toLowerCase();
  const sector = document.getElementById('sectorFilter').value;
  const routine = document.getElementById('routineFilter').value;
  const socialMedia = document.getElementById('socialMediaFilter').value;

  filteredData = temp.filter(row => {
    const matchesInstitution = !institution || (row['Kurum']||'').toString().toLowerCase().includes(institution);
    const matchesSector = !sector || row['SektÃ¶r'] === sector;
    const matchesRoutine = !routine || row['PaylaÅŸÄ±m Rutini'] === routine;
    const matchesSocialMedia = !socialMedia || row['Sosyal Medyada PaylaÅŸÄ±lacak mÄ±?'] === socialMedia;
    return matchesInstitution && matchesSector && matchesRoutine && matchesSocialMedia;
  });
  updateTable();
}
function filterByShareStatus(s){ currentShareFilter = s; applyFilters(); }
function filterByUpcoming(){ currentShareFilter = 'upcoming'; applyFilters(); }
function clearFilters(){
  document.getElementById('institutionFilter').value='';
  document.getElementById('sectorFilter').value='';
  document.getElementById('routineFilter').value='';
  document.getElementById('socialMediaFilter').value='';
  currentShareFilter='all'; applyFilters();
}

// GÃ¶rÃ¼nÃ¼r SÃ¼tunlar UI
function buildVisibleColumnsUI(){
  const container = document.getElementById('columnCheckboxes');
  container.innerHTML = '';
  const cols = Object.keys(DEFAULT_VISIBLE);
  cols.sort((a,b)=> (visibleCols[a]===visibleCols[b])?0:(visibleCols[a]?-1:1));
  cols.forEach(col => {
    const wrap = document.createElement('label');
    wrap.className = 'flex items-center gap-2 px-3 py-1 rounded-md hover:bg-gray-100 cursor-pointer';
    const cb = document.createElement('input');
    cb.type = 'checkbox'; cb.checked = !!visibleCols[col];
    cb.onchange = () => { visibleCols[col] = cb.checked; saveVisibleCols(); updateTable(); };
    const span = document.createElement('span'); span.textContent = formatColumnName(col);
    wrap.appendChild(cb); wrap.appendChild(span); container.appendChild(wrap);
  });
}

// Tablo
function updateAfterDataChange(){ updateSectorFilter(); buildVisibleColumnsUI(); updateTable(); updateStats(); }
function updateTable(){
  const body = document.getElementById('tableBody');
  const headRow = document.getElementById('tableHeadRow');
  headRow.innerHTML = `<th class="py-3 px-6"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>`;
  const cols = Object.keys(DEFAULT_VISIBLE);
  cols.forEach(col => {
    const th = document.createElement('th');
    th.className = 'py-3 px-6 ' + (visibleCols[col] ? '' : 'hidden');
    th.dataset.column = col;
    th.textContent = formatColumnName(col);
    headRow.appendChild(th);
  });
  const actionsTh = document.createElement('th'); actionsTh.className='py-3 px-6'; actionsTh.textContent='Ä°ÅŸlemler'; headRow.appendChild(actionsTh);

  body.innerHTML = '';
  filteredData.forEach((row, index) => {
    const tr = document.createElement('tr');
    tr.className = 'bg-white hover:bg-gray-50';
    if (row['Sosyal Medyada PaylaÅŸÄ±lacak mÄ±?'] === 'Evet') tr.classList.add('social-media-yes');
    else if (row['Sosyal Medyada PaylaÅŸÄ±lacak mÄ±?'] === 'Belki') tr.classList.add('social-media-maybe');

    const selectTd = document.createElement('td');
    selectTd.className='py-3 px-6';
    selectTd.innerHTML = `<input type="checkbox" class="rowCheckbox" data-index="${index}">`;
    tr.appendChild(selectTd);

    cols.forEach(col => {
      const td = document.createElement('td');
      td.className = 'py-3 px-6 ' + (visibleCols[col] ? '' : 'hidden');
      let cell = row[col] ?? '';
      if (col==='PaylaÅŸÄ±m Tarihi' && cell){
        try{ cell = new Date(cell).toLocaleDateString('tr-TR', {year:'numeric', month:'2-digit', day:'2-digit'}); }catch(e){}
      }
      if (col==='PaylaÅŸtÄ±ÄŸÄ±mÄ±z GÃ¶nderinin BaÄŸlantÄ± Adresi' || col==='Kaynak Ä°nternet Adresi'){
        if (cell){
          const a=document.createElement('a'); a.href=cell; a.target='_blank'; a.className='text-blue-600 hover:underline'; a.textContent='Link';
          td.appendChild(a);
        } else { td.textContent=''; }
      } else {
        td.textContent = cell;
      }
      tr.appendChild(td);
    });

    const actions = document.createElement('td');
    actions.className='py-3 px-6 flex items-center gap-2';
    actions.innerHTML = `
      <button onclick="updateSocialMediaStatus(${index}, 'Evet')" class="text-emerald-700 hover:underline">Evet</button>
      <button onclick="updateSocialMediaStatus(${index}, 'Belki')" class="text-amber-700 hover:underline">Belki</button>
      <button onclick="updateSocialMediaStatus(${index}, 'HayÄ±r')" class="text-gray-700 hover:underline">HayÄ±r</button>
      <button onclick="editRecord(${index})" title="DÃ¼zenle">âœï¸</button>
      <button onclick="deleteRecord(${index})" title="Sil">ğŸ—‘ï¸</button>
    `;
    tr.appendChild(actions);
    body.appendChild(tr);
  });
}
function updateStats(){
  const total = data.length;
  const shared = data.filter(r => r['PaylaÅŸÄ±ldÄ±']).length;
  const unshared = total - shared;
  const upcoming = data.filter(isUpcoming).length;
  document.getElementById('totalCount').textContent = total;
  document.getElementById('sharedCount').textContent = shared;
  document.getElementById('unsharedCount').textContent = unshared;
  document.getElementById('upcomingCount').textContent = upcoming;
  document.getElementById('filteredCount').textContent = filteredData.length;
}

// KayÄ±t iÅŸlemleri
function buildFormFields(){
  const container = document.getElementById('formFields');
  container.innerHTML = '';
  const fieldDefs = [
    ['Kurum','text'],['Alt Kurum','text'],['SektÃ¶r','text'],['PaylaÅŸÄ±m Konusu','text'],['PaylaÅŸÄ±m Tarihi','date'],
    ['Belirli bir gÃ¼nÃ¼ ve haftasÄ± var mÄ±?','select-yesno'],['Ä°rtibat KiÅŸisinin AdÄ± SoyadÄ±','text'],['Ä°rtibat KiÅŸisinin ÃœnvanÄ±','text'],
    ['Sorumlu KiÅŸi Ä°rtibat','text'],['PaylaÅŸtÄ±ÄŸÄ±mÄ±z GÃ¶nderinin BaÄŸlantÄ± Adresi','text'],['AÃ§Ä±klama','textarea'],
    ['Almanakta yer alan belirli gÃ¼n ve hafta ismi','text'],['BakanlÄ±ÄŸÄ±n PaylaÅŸÄ±m Metni','textarea'],["TUÄ°K'te var mÄ±?",'select-yesno'],
    ["TUÄ°K'te yayÄ±mlanma takvimi",'text'],['PaylaÅŸÄ±m Rutini','select-routine'],['Sosyal Medyada PaylaÅŸÄ±lacak mÄ±?','select-social'],
    ['Kaynak','text'],['Kaynak Ä°nternet Adresi','url'],['BakanlÄ±k Sosyal Medya PaylaÅŸÄ±mÄ± Var mÄ±?','select-yesno'],['PaylaÅŸÄ±ldÄ±','checkbox']
  ];
  for (const [label,type] of fieldDefs){
    const wrap = document.createElement('div'); let inner='';
    if (type==='text' || type==='url' || type==='date'){
      inner = `<label class="block text-sm font-medium text-gray-700">${label}</label>
               <input type="${type==='text'?'text':type}" name="${label}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50">`;
    } else if (type==='textarea'){
      inner = `<label class="block text	sm font-medium text-gray-700">${label}</label>
               <textarea name="${label}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50"></textarea>`;
    } else if (type==='select-yesno'){
      inner = `<label class="block text-sm font-medium text-gray-700">${label}</label>
               <select name="${label}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50">
                 <option value="HayÄ±r">HayÄ±r</option><option value="Evet">Evet</option>
               </select>`;
    } else if (type==='select-routine'){
      inner = `<label class="block text-sm font-medium text-gray-700">${label}</label>
               <select name="${label}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50">
                 <option value="Spontane">Spontane</option><option value="AylÄ±k">AylÄ±k</option><option value="YÄ±llÄ±k">YÄ±llÄ±k</option>
               </select>`;
    } else if (type==='select-social'){
      inner = `<label class="block text-sm font-medium text-gray-700">${label}</label>
               <select name="${label}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50">
                 <option value="HayÄ±r">HayÄ±r</option><option value="Evet">Evet</option><option value="Belki">Belki</option>
               </select>`;
    } else if (type==='checkbox'){
      inner = `<div class="flex items-center gap-2 mt-2">
                 <label class="text-sm font-medium text-gray-700">${label}</label>
                 <input type="checkbox" name="${label}">
               </div>`;
    }
    wrap.innerHTML = inner; container.appendChild(wrap);
  }
}
function showNewRecordForm(){
  const modal = document.getElementById('newRecordModal');
  buildFormFields();
  const form = document.getElementById('recordForm'); form.reset();
  form.onsubmit = saveRecord;
  modal.classList.remove('hidden');
}
function closeNewRecordModal(){ document.getElementById('newRecordModal').classList.add('hidden'); document.getElementById('recordForm').reset(); }
async function saveRecord(e){
  e.preventDefault();
  const form = e.target;
  const fd = new FormData(form);
  const rec = {}; Object.keys(DEFAULT_VISIBLE).forEach(k => rec[k]='');
  for (const [k,v] of fd.entries()){ rec[k] = (k==='PaylaÅŸÄ±ldÄ±') ? form.querySelector('input[name="PaylaÅŸÄ±ldÄ±"]').checked : v; }
  rec.id = form.querySelector('input[name="id"]').value || uid();
  if (!rec['Sosyal Medyada PaylaÅŸÄ±lacak mÄ±?']) rec['Sosyal Medyada PaylaÅŸÄ±lacak mÄ±?'] = 'HayÄ±r';
  try{ const exists = data.find(d=>d.id===rec.id); if(exists) await updateOnCloud(rec); else await createOnCloud(rec); await loadFromCloud(); closeNewRecordModal(); }
  catch(err){ alert('Kaydetme hatasÄ±: '+err.message); }
}
function editRecord(index){
  const record = filteredData[index];
  const form = document.getElementById('recordForm');
  buildFormFields(); form.reset();
  form.querySelector('input[name="id"]').value = record.id || '';
  Object.keys(record).forEach(k => { const el=form.querySelector(`[name="${k}"]`); if(!el) return; if(el.type==='checkbox'){ el.checked=!!record[k]; } else { el.value=record[k]||''; } });
  form.onsubmit = saveRecord;
  document.getElementById('newRecordModal').classList.remove('hidden');
}
async function deleteRecord(index){
  if(!confirm('Bu kaydÄ± silmek istediÄŸinize emin misiniz?')) return;
  const rec = filteredData[index];
  try{ await deleteOnCloud(rec.id); await loadFromCloud(); }catch(err){ alert('Silme hatasÄ±: '+err.message); }
}
async function updateSocialMediaStatus(index, status){
  const original = filteredData[index]; const rec = { ...original };
  rec['Sosyal Medyada PaylaÅŸÄ±lacak mÄ±?'] = status; rec['PaylaÅŸÄ±ldÄ±'] = (status==='Evet');
  try{ await updateOnCloud(rec); await loadFromCloud(); }catch(err){ alert('GÃ¼ncelleme hatasÄ±: '+err.message); }
}
function toggleSelectAll(){ const all = document.getElementById('selectAll').checked; document.querySelectorAll('.rowCheckbox').forEach(cb => cb.checked = all); }

function initialize(){
  buildVisibleColumnsUI();
  loadFromCloud().catch(err => { console.error(err); alert('Bulut verisi alÄ±namadÄ±. BACKEND_URL/Yetkiyi kontrol edin.'); });
  const dz = document.getElementById('dropZone');
  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('bg-blue-50'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('bg-blue-50'));
  dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('bg-blue-50'); handleFile(e.dataTransfer.files); });
  window.onclick = function(ev){ const m=document.getElementById('newRecordModal'); if(ev.target===m) closeNewRecordModal(); }
}
initialize();
</script>
</body>
</html>
