<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SMTS v2 – Google Sheets Entegrasyonlu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
      .shared-row { background-color: #A7F3D0 !important; color: #065F46 !important; }
      .shared-kpi { background-color: #D1FAE5; color: #065F46; }
      .upcoming-kpi { background-color: #BFDBFE; color: #1E40AF; }
      .filtered-kpi { background-color: #FEEBC7; color: #C05621; }
      .social-media-yes { background-color: #A7F3D0 !important; color: #065F46 !important; }
      .social-media-maybe { background-color: #FDE68A !important; color: #92400E !important; }
      th, td { white-space: nowrap; }
      .btn { @apply font-bold py-3 px-6 rounded-full shadow transition-all duration-300; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-6 md:p-10 lg:p-12">
    <div class="bg-white rounded-3xl shadow-xl p-6 md:p-10">
      <h1 class="text-3xl md:text-4xl lg:text-5xl font-extrabold text-center text-gray-700 mb-8">
        Sosyal Medya Paylaşım Takip Sistemi (SMTS v2)
      </h1>

      <div class="flex flex-wrap justify-center gap-3 md:gap-4 mb-8">
        <button onclick="document.getElementById('xlsxInput').click()" class="bg-blue-500 hover:bg-blue-600 text-white btn">.xlsx Yükle</button>
        <button onclick="exportToXLSX()" class="bg-green-500 hover:bg-green-600 text-white btn">.xlsx İndir</button>
        <button onclick="showNewRecordForm()" class="bg-purple-500 hover:bg-purple-600 text-white btn">Yeni Kayıt</button>
        <button onclick="clearData()" class="bg-red-500 hover:bg-red-600 text-white btn">Temizle (Bulut+Önbellek)</button>
      </div>
      <input type="file" id="xlsxInput" accept=".xlsx" class="hidden" onchange="handleFile(this.files)"/>

      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6 mb-8">
        <div id="totalStat" onclick="filterByShareStatus('all')" class="bg-indigo-200 hover:bg-indigo-300 text-indigo-800 font-bold p-6 rounded-2xl shadow-md cursor-pointer flex justify-between items-center">
          <span class="text-lg">Toplam Kayıt</span><span id="totalCount" class="text-3xl md:text-4xl">0</span>
        </div>
        <div id="sharedStat" onclick="filterByShareStatus('shared')" class="shared-kpi hover:bg-green-300 font-bold p-6 rounded-2xl shadow-md cursor-pointer flex justify-between items-center">
          <span class="text-lg">Paylaşılan</span><span id="sharedCount" class="text-3xl md:text-4xl">0</span>
        </div>
        <div id="unsharedStat" onclick="filterByShareStatus('unshared')" class="bg-pink-200 hover:bg-pink-300 text-pink-800 font-bold p-6 rounded-2xl shadow-md cursor-pointer flex justify-between items-center">
          <span class="text-lg">Paylaşılmayan</span><span id="unsharedCount" class="text-3xl md:text-4xl">0</span>
        </div>
        <div id="upcomingStat" onclick="filterByUpcoming()" class="upcoming-kpi hover:bg-blue-300 font-bold p-6 rounded-2xl shadow-md cursor-pointer flex justify-between items-center">
          <span class="text-lg">Yaklaşan Paylaşımlar</span><span id="upcomingCount" class="text-3xl md:text-4xl">0</span>
        </div>
        <div id="filteredStat" onclick="filterByCurrent()" class="filtered-kpi hover:bg-orange-300 font-bold p-6 rounded-2xl shadow-md cursor-pointer flex justify-between items-center">
          <span class="text-lg">Filtrelenen Satır</span><span id="filteredCount" class="text-3xl md:text-4xl">0</span>
        </div>
      </div>

      <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">Filtrele</h3>
      <div class="bg-blue-100 p-6 rounded-xl shadow-inner mb-4">
        <div class="flex flex-wrap items-center justify-center gap-4">
          <div>
            <label class="block text-sm font-medium text-blue-800">Paylaşım Rutini</label>
            <select id="routineFilter" onchange="applyFilters()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
              <option value="">Tümü</option><option value="Spontane">Spontane</option><option value="Aylık">Aylık</option><option value="Yıllık">Yıllık</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-blue-800">Sosyal Medyada Paylaşılacak mı?</label>
            <select id="socialMediaFilter" onchange="applyFilters()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
              <option value="">Tümü</option><option value="Evet">Evet</option><option value="Hayır">Hayır</option><option value="Belki">Belki</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-blue-800">Kurum Filtresi</label>
            <input id="institutionFilter" oninput="applyFilters()" placeholder="Kurum adı yazın…" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" />
          </div>
          <div>
            <label class="block text-sm font-medium text-blue-800">Sektör Filtresi</label>
            <select id="sectorFilter" onchange="applyFilters()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
              <option value="">Tümü</option>
            </select>
          </div>
        </div>
      </div>

      <div class="bg-gray-200 p-6 rounded-xl shadow-inner mb-8">
        <div class="flex flex-wrap items-center justify-center gap-6">
          <label class="flex items-center space-x-2 text-sm font-medium text-gray-800">
            <input type="checkbox" id="similarShareFilter" onchange="applyFilters()"/><span>Bakanlık Paylaşımı Olanlar</span>
          </label>
          <label class="flex items-center space-x-2 text-sm font-medium text-gray-800">
            <input type="checkbox" id="webSourceFilter" onchange="applyFilters()"/><span>Kaynak Web Adresi Olanlar</span>
          </label>
          <label class="flex items-center space-x-2 text-sm font-medium text-gray-800">
            <input type="checkbox" id="almanacFilter" onchange="applyFilters()"/><span>Belirli gün/haftası olanlar</span>
          </label>
          <label class="flex items-center space-x-2 text-sm font-medium text-gray-800">
            <input type="checkbox" id="tuikFilter" onchange="applyFilters()"/><span>TUİK'te yer alanlar</span>
          </label>
          <button onclick="clearFilters()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-2 px-4 rounded-full">Filtreleri Temizle</button>
        </div>
      </div>

      <div class="bg-gray-50 p-6 rounded-xl shadow-inner mb-8">
        <h3 class="text-lg font-semibold text-gray-600 mb-4 text-center">Görünür Sütunlar</h3>
        <div id="columnCheckboxes" class="flex flex-wrap justify-center gap-x-6 gap-y-2 text-sm text-gray-600"></div>
      </div>

      <div id="dropZone" class="border-2 border-dashed border-gray-400 rounded-xl p-6 text-center text-gray-500 mb-8">
        Dosyanızı buraya sürükleyip bırakın (.xlsx)
      </div>

      <div class="overflow-x-auto rounded-xl shadow-md">
        <table class="w-full text-sm text-left text-gray-500">
          <thead class="text-xs text-gray-700 uppercase bg-gray-200 sticky top-0 border-2 border-gray-400">
            <tr id="tableHeadRow">
              <th class="py-3 px-6 border-r-2 border-gray-400"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
              <!-- Dinamik başlıklar eklenecek -->
              <th class="py-3 px-6">İşlemler</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="bg-white divide-y-2 divide-gray-300"></tbody>
        </table>
      </div>

      <div id="newRecordModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-8 rounded-xl bg-white shadow-2xl w-11/12 md:max-w-xl lg:max-w-2xl">
          <span class="text-gray-500 hover:text-gray-700 text-3xl font-bold absolute top-4 right-6 cursor-pointer" onclick="closeNewRecordModal()">&times;</span>
          <h2 class="text-2xl font-bold text-gray-700 mb-6 text-center">Yeni Kayıt Ekle/Düzenle</h2>
          <form id="recordForm">
            <input type="hidden" name="id" />
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="formFields"></div>
            <div class="flex justify-end mt-6 space-x-4">
              <button type="button" onclick="closeNewRecordModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full">İptal</button>
              <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">Kaydet</button>
            </div>
          </form>
        </div>
      </div>

      <p class="text-center text-sm text-gray-500 mt-8 mb-2">Veriler bulutta (Google Sheets) saklanır. Cihazınızda son görüntülenen hali de önbelleğe alınır.</p>
      <p class="text-center text-xs text-gray-400">&copy; Made by B.A.</p>
    </div>
  </div>

<script>
// ======= AYARLAR =======
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbwRDOtvOzakzoqu-3-Cga-_AUDqarGjbQ_tdimozxqfZLv0m9dZPk2P0DGJ_uOQpt28KA/exec"; // Google Apps Script Web App URL
const SHEET_COLUMNS = [
  'id','Kurum','Alt Kurum','Sektör','Paylaşım Konusu','Paylaşım Tarihi',
  'Belirli bir günü ve haftası var mı?','İrtibat Kişisinin Ünvanı','İrtibat Kişisinin Adı Soyadı',
  'Paylaştığımız Gönderinin Bağlantı Adresi','Açıklama','Almanakta yer alan belirli gün ve hafta ismi',
  'Bakanlığın Paylaşım Metni',"TUİK'te var mı?","TUİK'te yayımlanma takvimi",
  'Paylaşım Rutini','Sosyal Medyada Paylaşılacak mı?','Kaynak','Kaynak İnternet Adresi',
  'Bakanlık Sosyal Medya Paylaşımı Var mı?','Paylaşıldı'
];
const DEFAULT_VISIBLE = {
  'Kurum': true,'Alt Kurum': false,'Sektör': false,'Paylaşım Konusu': true,'Paylaşım Tarihi': true,
  'Belirli bir günü ve haftası var mı?': false,'İrtibat Kişisinin Ünvanı': false,'İrtibat Kişisinin Adı Soyadı': false,
  'Paylaştığımız Gönderinin Bağlantı Adresi': false,'Açıklama': true,'Almanakta yer alan belirli gün ve hafta ismi': false,
  'Bakanlığın Paylaşım Metni': false,"TUİK'te var mı?": false,"TUİK'te yayımlanma takvimi": false,'Paylaşım Rutini': false,
  'Sosyal Medyada Paylaşılacak mı?': false,'Kaynak': false,'Kaynak İnternet Adresi': false,'Bakanlık Sosyal Medya Paylaşımı Var mı?': false,'Paylaşıldı': false
};

// ======= DURUM =======
let data = []; let filteredData = []; let editIndex = null; let currentShareFilter = 'all';
let visibleCols = { ...DEFAULT_VISIBLE };

// ======= YARDIMCI =======
function uid(){ return 'id-' + Math.random().toString(36).slice(2) + Date.now(); }
function formatColumnName(col){
  const map = {
    'Paylaşım Konusu':'Konu',
    'Paylaştığımız Gönderinin Bağlantı Adresi':'Paylaşım Adresi',
    'Almanakta yer alan belirli gün ve hafta ismi':'Almanak Adı',
    'Bakanlığın Paylaşım Metni':'Bakanlık Metni',
    "TUİK'te yayımlanma takvimi":'TUİK Takvimi',
    'Kaynak İnternet Adresi':'Kaynak Web Adresi',
    'Bakanlık Sosyal Medya Paylaşımı Var mı?':'Bakanlık Paylaşımı Var mı?',
    'Paylaşıldı':'Paylaşıldı ✔'
  };
  return map[col] || col;
}

// ======= BACKEND =======
async function backend(action, payload = {}){
  const res = await fetch(BACKEND_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify({ action, ...payload })
  });
  if(!res.ok) throw new Error('Ağ hatası');
  return await res.json();
}

async function loadFromCloud(){
  const cached = localStorage.getItem('smts_cache');
  if (cached) { try { data = JSON.parse(cached); filteredData = [...data]; updateAfterDataChange(); } catch(e){} }
  const result = await backend('list');
  data = result.rows || [];
  filteredData = [...data];
  localStorage.setItem('smts_cache', JSON.stringify(data));
  updateAfterDataChange();
}

async function createOnCloud(record){ record.id = record.id || uid(); await backend('create', { record }); }
async function updateOnCloud(record){ if(!record.id) throw new Error('id yok'); await backend('update', { record }); }
async function deleteOnCloud(id){ await backend('delete', { id }); }
async function clearCloud(){ await backend('clear'); }

// ======= EXCEL İÇE/DIŞA AKTARIM =======
function handleFile(files){
  const file = files[0];
  if (!file || !file.name.endsWith('.xlsx')) return;
  const reader = new FileReader();
  reader.onload = async e => {
    const wb = XLSX.read(e.target.result, { type:'binary' });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);
    const toUpload = json.map(row => {
      const r = {}; SHEET_COLUMNS.forEach(k => r[k] = row[k] ?? '');
      if(!r.id) r.id = uid();
      if (r['Paylaşım Tarihi'] && typeof r['Paylaşım Tarihi'] === 'number') {
        // Excel seri tarih → ISO
        const d = new Date(Date.UTC(0,0,r['Paylaşım Tarihi'] - 1));
        r['Paylaşım Tarihi'] = d.toISOString().slice(0,10);
      }
      if (!r['Sosyal Medyada Paylaşılacak mı?']) r['Sosyal Medyada Paylaşılacak mı?'] = 'Hayır';
      r['Paylaşıldı'] = (r['Paylaşıldı'] === true || r['Paylaşıldı'] === '✔');
      return r;
    });
    await clearCloud();
    for (const rec of toUpload) await createOnCloud(rec);
    await loadFromCloud();
  };
  reader.readAsBinaryString(file);
}

function exportToXLSX(){
  const ws = XLSX.utils.json_to_sheet(filteredData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Paylaşım Paneli');
  XLSX.writeFile(wb, 'paylasim_paneli.xlsx');
}

// ======= TABLO =======
function updateAfterDataChange(){
  updateSectorFilter();
  applyFilters();
  updateColumnCheckboxes();
}

function updateTable(){
  const tableBody = document.getElementById('tableBody');
  const headRow = document.getElementById('tableHeadRow');
  headRow.innerHTML = `<th class="py-3 px-6 border-r-2 border-gray-400"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>`;

  const all = Object.keys(visibleCols);
  const visible = all.filter(c => visibleCols[c]);
  const hidden = all.filter(c => !visibleCols[c]);

  for(const col of visible){
    const th = document.createElement('th');
    th.className = 'py-3 px-6 border-r-2 border-gray-400';
    th.dataset.column = col;
    th.textContent = formatColumnName(col);
    headRow.appendChild(th);
  }
  for(const col of hidden){
    const th = document.createElement('th');
    th.className = 'py-3 px-6 hidden border-r-2 border-gray-400';
    th.dataset.column = col;
    th.textContent = formatColumnName(col);
    headRow.appendChild(th);
  }
  const actionsTh = document.createElement('th'); actionsTh.className='py-3 px-6'; actionsTh.textContent='İşlemler'; headRow.appendChild(actionsTh);

  tableBody.innerHTML = '';
  filteredData.forEach((row, index) => {
    const tr = document.createElement('tr');
    tr.className = 'bg-white border-b-2 border-gray-300 hover:bg-gray-50';
    if (row['Sosyal Medyada Paylaşılacak mı?'] === 'Evet') tr.classList.add('social-media-yes');
    else if (row['Sosyal Medyada Paylaşılacak mı?'] === 'Belki') tr.classList.add('social-media-maybe');

    const selectTd = document.createElement('td');
    selectTd.className = 'py-4 px-6 border-r-2 border-gray-300';
    selectTd.innerHTML = `<input type="checkbox" class="rowCheckbox" data-index="${index}">`;
    tr.appendChild(selectTd);

    for(const col of Object.keys(visibleCols)){
      const td = document.createElement('td');
      td.className = 'py-4 px-6 border-r-2 border-gray-300';
      if (!visibleCols[col]) td.classList.add('hidden');
      let cell = row[col] ?? '';
      if (col === 'Paylaşım Tarihi' && cell){
        try { cell = new Date(cell).toLocaleDateString('tr-TR', {year:'numeric', month:'2-digit', day:'2-digit'}); } catch(e) { }
      }
      if (col === 'Paylaştığımız Gönderinin Bağlantı Adresi' || col === 'Kaynak İnternet Adresi') {
        if (cell) {
          const a = document.createElement('a');
          a.href = cell; a.target = '_blank'; a.className = 'text-blue-600 hover:underline'; a.textContent = 'Link';
          td.appendChild(a);
        } else td.textContent = '';
      } else td.textContent = cell;
      tr.appendChild(td);
    }
    const actions = document.createElement('td');
    actions.className = 'py-4 px-6 flex items-center gap-2';
    actions.innerHTML = `
      <button onclick="updateSocialMediaStatus(${index}, 'Evet')" class="text-green-600 hover:text-green-800">Evet</button>
      <button onclick="updateSocialMediaStatus(${index}, 'Belki')" class="text-yellow-600 hover:text-yellow-800">Belki</button>
      <button onclick="updateSocialMediaStatus(${index}, 'Hayır')" class="text-gray-600 hover:text-gray-800">Hayır</button>
      <button onclick="editRecord(${index})" class="text-yellow-600 hover:text-yellow-800" title="Düzenle">✏️</button>
      <button onclick="deleteRecord(${index})" class="text-red-600 hover:text-red-800" title="Sil">🗑️</button>
    `;
    tr.appendChild(actions);
    tableBody.appendChild(tr);
  });
  updateStats();
}

function updateStats(){
  const total = data.length;
  const shared = data.filter(r => r['Paylaşıldı']).length;
  const unshared = total - shared;
  const upcoming = data.filter(isUpcoming).length;
  document.getElementById('totalCount').textContent = total;
  document.getElementById('sharedCount').textContent = shared;
  document.getElementById('unsharedCount').textContent = unshared;
  document.getElementById('upcomingCount').textContent = upcoming;
  document.getElementById('filteredCount').textContent = filteredData.length;
}

function isUpcoming(row){
  if (!row['Paylaşım Tarihi']) return false;
  const planned = new Date(row['Paylaşım Tarihi']);
  const today = new Date(); today.setHours(0,0,0,0);
  const tenDays = new Date(today); tenDays.setDate(today.getDate()+10); tenDays.setHours(23,59,59,999);
  return planned >= today && planned <= tenDays && !row['Paylaşıldı'];
}

// ======= FİLTRE =======
function updateSectorFilter(){
  const sectors = [...new Set(data.map(r => r['Sektör']).filter(Boolean))];
  const sel = document.getElementById('sectorFilter');
  sel.innerHTML = '<option value="">Tümü</option>';
  sectors.forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });
}

function applyFilters(){
  let temp = [...data];
  if (currentShareFilter === 'shared') temp = temp.filter(r => r['Paylaşıldı']);
  else if (currentShareFilter === 'unshared') temp = temp.filter(r => !r['Paylaşıldı']);
  else if (currentShareFilter === 'upcoming') temp = temp.filter(isUpcoming);

  const institution = document.getElementById('institutionFilter').value.trim().toLowerCase();
  const sector = document.getElementById('sectorFilter').value;
  const similarShare = document.getElementById('similarShareFilter').checked;
  const webSource = document.getElementById('webSourceFilter').checked;
  const almanacLinked = document.getElementById('almanacFilter').checked;
  const tuikLinked = document.getElementById('tuikFilter').checked;
  const routine = document.getElementById('routineFilter').value;
  const socialMedia = document.getElementById('socialMediaFilter').value;

  filteredData = temp.filter(row => {
    const matchesInstitution = !institution || (row['Kurum']||'').toString().toLowerCase().includes(institution);
    const matchesSector = !sector || row['Sektör'] === sector;
    const matchesSimilarShare = !similarShare || (row['Bakanlık Sosyal Medya Paylaşımı Var mı?']||'').toString().toLowerCase() === 'evet';
    const matchesWebSource = !webSource || ((row['Kaynak İnternet Adresi']||'').trim() !== '');
    const matchesAlmanac = !almanacLinked || (row['Belirli bir günü ve haftası var mı?']||'').toString().toLowerCase() === 'evet';
    const matchesTUİK = !tuikLinked || ((row["TUİK'te var mı?"]||'').toString().toLowerCase() === 'evet');
    const matchesRoutine = !routine || row['Paylaşım Rutini'] === routine;
    const matchesSocialMedia = !socialMedia || row['Sosyal Medyada Paylaşılacak mı?'] === socialMedia;
    return matchesInstitution && matchesSector && matchesSimilarShare && matchesWebSource && matchesAlmanac && matchesTUİK && matchesRoutine && matchesSocialMedia;
  });
  updateTable();
}

function filterByCurrent(){ updateTable(); }
function filterByShareStatus(status){ currentShareFilter = status; applyFilters(); }
function filterByUpcoming(){ currentShareFilter = 'upcoming'; applyFilters(); }
function clearFilters(){
  document.getElementById('institutionFilter').value='';
  document.getElementById('sectorFilter').value='';
  document.getElementById('similarShareFilter').checked=false;
  document.getElementById('webSourceFilter').checked=false;
  document.getElementById('almanacFilter').checked=false;
  document.getElementById('tuikFilter').checked=false;
  document.getElementById('routineFilter').value='';
  document.getElementById('socialMediaFilter').value='';
  currentShareFilter='all'; applyFilters();
}

// ======= FORM =======
function buildFormFields(){
  const container = document.getElementById('formFields');
  container.innerHTML = '';
  const fieldDefs = [
    ['Kurum','text'],['Alt Kurum','text'],['Sektör','text'],['Paylaşım Konusu','text'],['Paylaşım Tarihi','date'],
    ['Belirli bir günü ve haftası var mı?','select-yesno'],['İrtibat Kişisinin Adı Soyadı','text'],['İrtibat Kişisinin Ünvanı','text'],
    ['Sorumlu Kişi İrtibat','text'],['Paylaştığımız Gönderinin Bağlantı Adresi','text'],['Açıklama','textarea'],
    ['Almanakta yer alan belirli gün ve hafta ismi','text'],['Bakanlığın Paylaşım Metni','textarea'],["TUİK'te var mı?",'select-yesno'],
    ["TUİK'te yayımlanma takvimi",'text'],['Paylaşım Rutini','select-routine'],['Sosyal Medyada Paylaşılacak mı?','select-social'],
    ['Kaynak','text'],['Kaynak İnternet Adresi','url'],['Bakanlık Sosyal Medya Paylaşımı Var mı?','select-yesno'],['Paylaşıldı','checkbox']
  ];
  for (const [label,type] of fieldDefs){
    const wrap = document.createElement('div'); let inner = '';
    if (type==='text' || type==='url' || type==='date'){
      inner = `<label class="block text-sm font-medium text-gray-700">${label}</label>
               <input type="${type==='text'?'text':type}" name="${label}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50">`;
    } else if (type==='textarea'){
      inner = `<label class="block text-sm font-medium text-gray-700">${label}</label>
               <textarea name="${label}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50"></textarea>`;
    } else if (type==='select-yesno'){
      inner = `<label class="block text-sm font-medium text-gray-700">${label}</label>
               <select name="${label}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50">
                 <option value="Hayır">Hayır</option><option value="Evet">Evet</option>
               </select>`;
    } else if (type==='select-routine'){
      inner = `<label class="block text-sm font-medium text-gray-700">${label}</label>
               <select name="${label}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50">
                 <option value="Spontane">Spontane</option><option value="Aylık">Aylık</option><option value="Yıllık">Yıllık</option>
               </select>`;
    } else if (type==='select-social'){
      inner = `<label class="block text-sm font-medium text-gray-700">${label}</label>
               <select name="${label}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50">
                 <option value="Hayır">Hayır</option><option value="Evet">Evet</option><option value="Belki">Belki</option>
               </select>`;
    } else if (type==='checkbox'){
      inner = `<div class="flex items-center space-x-2 mt-2">
                 <label class="text-sm font-medium text-gray-700">${label}</label>
                 <input type="checkbox" name="${label}">
               </div>`;
    }
    wrap.innerHTML = inner; container.appendChild(wrap);
  }
}

function showNewRecordForm(){
  editIndex = null;
  document.getElementById('newRecordModal').classList.remove('hidden');
  buildFormFields();
  const form = document.getElementById('recordForm'); form.reset();
  form.onsubmit = saveRecord;
}

function closeNewRecordModal(){
  document.getElementById('newRecordModal').classList.add('hidden');
  document.getElementById('recordForm').reset(); editIndex = null;
}

async function saveRecord(e){
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);
  const rec = {}; SHEET_COLUMNS.forEach(k => { if (k!=='id') rec[k]=''; });
  for (const [key,val] of formData.entries()){ rec[key] = (key==='Paylaşıldı') ? form.querySelector('input[name="Paylaşıldı"]').checked : val; }
  rec.id = form.querySelector('input[name="id"]').value || uid();
  if (!rec['Sosyal Medyada Paylaşılacak mı?']) rec['Sosyal Medyada Paylaşılacak mı?'] = 'Hayır';
  try{ const exists = data.find(d => d.id === rec.id); if (exists) await updateOnCloud(rec); else await createOnCloud(rec); await loadFromCloud(); closeNewRecordModal(); }
  catch(err){ alert('Kaydetme hatası: ' + err.message); }
}

function editRecord(index){
  editIndex = index;
  const record = filteredData[index];
  const form = document.getElementById('recordForm');
  buildFormFields(); form.reset();
  form.querySelector('input[name="id"]').value = record.id || '';
  for(const k of Object.keys(record)){
    const input = form.querySelector(`[name="${k}"]`);
    if (!input) continue;
    if (input.type === 'checkbox') input.checked = !!record[k]; else input.value = record[k] ?? '';
  }
  form.onsubmit = saveRecord;
  document.getElementById('newRecordModal').classList.remove('hidden');
}

async function deleteRecord(index){
  if (!confirm('Bu kaydı silmek istediğinize emin misiniz?')) return;
  const rec = filteredData[index];
  try{ await deleteOnCloud(rec.id); await loadFromCloud(); } catch(err){ alert('Silme hatası: ' + err.message); }
}

async function updateSocialMediaStatus(index, newStatus){
  const original = filteredData[index]; const rec = { ...original };
  rec['Sosyal Medyada Paylaşılacak mı?'] = newStatus; rec['Paylaşıldı'] = (newStatus === 'Evet');
  try{ await updateOnCloud(rec); await loadFromCloud(); } catch(err){ alert('Güncelleme hatası: ' + err.message); }
}

function toggleSelectAll(){
  const all = document.getElementById('selectAll').checked;
  document.querySelectorAll('.rowCheckbox').forEach(cb => cb.checked = all);
}

async function clearData(){
  if(!confirm('Buluttaki TÜM verileri ve önbelleği silmek istiyor musunuz?')) return;
  try{ await clearCloud(); localStorage.removeItem('smts_cache'); data=[]; filteredData=[]; updateAfterDataChange(); }
  catch(err){ alert('Temizleme hatası: ' + err.message); }
}

// ======= KOLON KONTROLLERİ =======
function updateColumnCheckboxes(){
  const container = document.getElementById('columnCheckboxes');
  container.innerHTML = '';
  const sorted = Object.keys(visibleCols).sort((a,b)=> (visibleCols[a]===visibleCols[b])?0:(visibleCols[a]?-1:1));
  sorted.forEach(col => {
    const label = document.createElement('label'); label.className = 'flex items-center';
    const input = document.createElement('input'); input.type='checkbox'; input.checked = visibleCols[col]; input.className='mr-2';
    input.onchange = () => { visibleCols[col] = !visibleCols[col]; updateTable(); };
    const span = document.createElement('span'); span.textContent = formatColumnName(col);
    label.appendChild(input); label.appendChild(span); container.appendChild(label);
  });
}

// ======= BAŞLAT =======
function initialize(){
  updateColumnCheckboxes();
  loadFromCloud().catch(err => { console.error(err); alert('Bulut verisi alınamadı. Lütfen BACKEND_URL ayarlayın ya da yetki verin.'); });
  const dropZone = document.getElementById('dropZone');
  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('bg-blue-50'); });
  dropZone.addEventListener('dragleave', e => { dropZone.classList.remove('bg-blue-50'); });
  dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('bg-blue-50'); handleFile(e.dataTransfer.files); });
  window.onclick = function(event){ const modal=document.getElementById('newRecordModal'); if (event.target==modal) closeNewRecordModal(); }
}
initialize();
</script>
</body>
</html>
